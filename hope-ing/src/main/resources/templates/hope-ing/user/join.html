<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.tymeleaf.org">
<head>
<meta charset="UTF-8">
<link rel="stylesheet" href="/css/bootstrap/bootstrap.css" type="text/css">
<link rel="stylesheet" href="/css/join.css">
<title>Hope-ing</title>
</head>
<body>
<div class="wrap">
	<form method="post" id="joinForm">
		<div class="user_id" style="text-align: center;">
			<div class="user_id_input_box">
				<input class="user_id_input" name="user_id" placeholder="아이디(5~20자의 영문 소문자, 숫자, 특수기호(_))" required>
				<div class="error-message" style="color: red;"></div>
			</div>
		</div>
		<br>
		<div class="user_pw" style="text-align: center;">
			<div class="user_pw_input_box">
				<input class="user_pw_input" name="user_pw" placeholder="비밀번호(8~20자의 영문 대/소문자, 숫자, 특수문자)">
				<div class="error-message" style="color: red;"></div>
			</div>
		</div>
		<br>
		<div class="user_pw_confirm" style="text-align: center;">
			<div class="user_pw_confirm_input_box">
				<input class="user_pw_confirm_input" name="user_pw_confirm" placeholder="비밀번호 확인">
				<div class="error-message" style="color: red;"></div>
			</div>
		</div>
		<br>
		<div class="user_name" style="text-align: center;">
			<div class="user_name_input_box">
				<input class="user_name_input" name="user_name" placeholder="이름">
				<div class="error-message" style="color: red;"></div>
			</div>
		</div>
		<br>
		<div class="user_nickname" style="text-align: center;">
			<div class="user_nickname_input_box">
				<input class="user_nickname_input" name="user_nickname" placeholder="닉네임(2~20자의 영문 소문자, 숫자, 특수기호(_)" >
				<div class="error-message" style="color: red;"></div>
			</div>
		</div>
		<br>
		<div class="user_email" style="text-align: center;">
			<div class="user_email_input_box">
				<input class="user_email_input" name="user_email" placeholder="이메일">
				<div class="error-message" style="color: red;"></div>
			</div>
		</div>
		<br>
		<div class="user_phone_num" style="text-align: center;">
			<div class="user_phone_num_input_box">
				<input class="user_phone_num_input" name="user_phone_num" placeholder="전화번호(- 제외)">
				<div class="error-message" style="color: red;"></div>
			</div>
		</div>
		<br>
		<div class="join_button" style="text-align: center;">
			<button id="join_button" type="submit" class="btn btn-lg" style="background-color: #9edfbf;">가입하기</button>
		</div>
	</form>
</div>
<script th:src="@{/js/jquery-3.6.4.js}"></script>
<script>
// 아이디 중복 체크 함수
function checkDuplicateUserId(userId) {
    var isDuplicate = false;
    
    // AJAX를 이용하여 서버에 아이디 중복 체크 요청
    $.ajax({
        type: "GET",
        url: "/hope-ing/user/join",
        data: { user_id: userId },
        async: false, // 동기 요청 (응답이 올 때까지 대기)
        success: function(response) {
            if (response) {
                // 중복된 아이디인 경우
                isDuplicate = true;
            }
        },
        error: function(xhr, status, error) {
            console.error(error);
        }
    });
    
    return isDuplicate;
}
	const form = document.getElementById('joinForm');
	const userIdInput = document.querySelector('.user_id_input');
	const userPwInput = document.querySelector('.user_pw_input');
	const userPwConfirmInput = document.querySelector('.user_pw_confirm_input');
	const userNameInput = document.querySelector('.user_name_input');
	const userNicknameInput = document.querySelector('.user_nickname_input');
	const userEmailInput = document.querySelector('.user_email_input');
	const userPhoneNumInput = document.querySelector('.user_phone_num_input');
	
	form.addEventListener('submit', function(event) {
		event.preventDefault();
		// 아이디 중복 체크
		const userId = userIdInput.value;
		const isDuplicate = checkDuplicateUserId(userId);
		
		if (isDuplicate) {
            userIdInput.classList.add('error');
            userIdInput.nextElementSibling.innerText = '이미 사용 중인 아이디입니다.';
            return;
        } else {
            userIdInput.classList.remove('error');
            userIdInput.nextElementSibling.innerText = '';
        }
		
		// 정규 표현식 패턴 설정
		const userIdPattern = /^[\w]{5,20}$/;
		const userPwPattern = /^(?=.*[A-Za-z])(?=.*\d)(?=.*[@#$%^&+=!*])(?!.*\s).{8,20}$/;
		const userNamePattern = /^[a-zA-Z가-힣]{2,20}$/;
		const userNicknamePattern = /^[\w가-힣]{2,20}$/;
		const userEmailPattern = /^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$/;
		const userPhoneNumPattern = /^\d{10,20}$/;
		
		// 아이디 정규식
		if (!userIdPattern.test(userIdInput.value)) {
			userIdInput.classList.add('error');
			userIdInput.nextElementSibling.innerText = '아이디를 확인해주세요.';
		}
		else {
			userIdInput.classList.remove('error');
			userIdInput.nextElementSibling.innerText = '';
		}
		
		// 비밀번호 정규식
		if (!userPwPattern.test(userPwInput.value)) {
			userPwInput.classList.add('error');
			userPwInput.nextElementSibling.innerText = '비밀번호를 확인해주세요.';
		}
		else {
			userPwInput.classList.remove('error');
			userPwInput.nextElementSibling.innerText = '';
		}
		
		// 비밀번호 확인
		if (userPwInput.value !== userPwConfirmInput.value) {
			userPwConfirmInput.classList.add('error');
			userPwConfirmInput.nextElementSibling.innerText = '비밀번호가 일치하지 않습니다.';
		}
		else {
			userPwConfirmInput.classList.remove('error');
			userPwConfirmInput.nextElementSibling.innerText = '';
		}
		
		// 이름 정규식
		if (!userNamePattern.test(userNameInput.value)) {
			userNameInput.classList.add('error');
			userNameInput.nextElementSibling.innerText = '이름을 확인해주세요.';
		}
		else {
			userNameInput.classList.remove('error');
			userNameInput.nextElementSibling.innerText = '';
		}
		
		// 닉네임 정규식
		if (!userNicknamePattern.test(userNicknameInput.value)) {
			userNicknameInput.classList.add('error');
			userNicknameInput.nextElementSibling.innerText = '닉네임을 확인해주세요.';
		}
		else {
			userNicknameInput.classList.remove('error');
			userNicknameInput.nextElementSibling.innerText = '';
		}
		
		// 이메일 정규식
		if (!userEmailPattern.test(userEmailInput.value)) {
			userEmailInput.classList.add('error');
			userEmailInput.nextElementSibling.innerText = '유효한 이메일 주소를 입력해야 합니다.';
		}
		else {
			userEmailInput.classList.remove('error');
			userEmailInput.nextElementSibling.innerText = '';
		}
		
		// 전화번호 정규식
		if (!userPhoneNumPattern.test(userPhoneNumInput.value)) {
			userPhoneNumInput.classList.add('error');
			userPhoneNumInput.nextElementSibling.innerText = '전화번호를 확인해주세요.';
		}
		else {
			userPhoneNumInput.classList.remove('error');
			userPhoneNumInput.nextElementSibling.innerText = '';
		}
		
		if (!form.querySelectorAll('.error').length) {
			form.submit();
		}
	});
</script>
</body>
</html>